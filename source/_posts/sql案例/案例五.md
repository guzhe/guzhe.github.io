---
title: sql案例五
hidden: true
author: guz
tags:
  - sql
categories:
  - 开发
date: 2025-10-13 11:22:18  
---
数据显示说明:
[1]抓取临期未被续租单元，一个单元一行数据
抓取单元基础资料中 项目中各租赁分区  在高标合同台账中 合同类型=招商合同中 符合查询条件日期的 最后一笔 的合同记录，并判断该分区 是否有后续的合同。如果没有后续合同，则视为临期且未被续租单元。
显示该单元对应的合同，单元租期，单元基础资料面积，合同签约面积
[2]计算单元平均价格=A=  （单价1*天数1+单价2*天数2）/（天数1+天数2）
[3]计算单元最后一年平均价格=B
如果单元结束日期=2025/9/12 
 如果合同租期不满一年，则直接=A，否则找该合同中 2024/9/13~2025/9/12的价格,计算平均价格
[4]以上计算时，月单价需要最终转换成日单价 ，=price*12/365
[5]平均单价保留4位小数
[6]排序：项目名称/租户名称/合同号/租期起/租期止/单元名称

方案： 
查询条件： 开始日期：2025-08-21 结束日期：2025-11-21  
~~~sql
SELECT
	a.area_name,
	a.mall_code,
	a.mall_name,
	a.COMPANY_NAME,
	a.CONT_NO,
	a.cont_begin_date,
	a.CONT_END_DATE,
	a.STORE_ID,
	c.STORE_NAME,
	c.RENT_SQUARE,
	a.sign_square,
	a.store_group_id,
	a.price_type,
	AAA.price1,
	AAA.price2 
FROM
	(
	SELECT
		ma.area_name,
		s.sign_square,
		m.mall_code,
		m.mall_name,
		m.BELONG_NAME,
		b.COMPANY_NAME,
		b.MALL_ID,
		b.CONT_NO,
		b.cont_type,
		b.COMPANY_ID,
		s.store_group_id,
		s.start_date cont_begin_date,
		s.end_date CONT_END_DATE,
		s.STORE_ID,
		ss.price_type 
	FROM
		ibp_enrolment.bs_cont b
		LEFT JOIN bs_mall m ON b.mall_id = m.id
		LEFT JOIN bs_mall_area ma ON ma.mall_code = m.MALL_CODE
		LEFT JOIN ibp_enrolment.bs_cont_store_detail s ON b.CONT_NO = s.cont_no 
		AND s.is_del = 0
		LEFT JOIN ibp_enrolment.bs_cont_extend ss ON b.CONT_NO = ss.cont_no 
		AND ss.is_del = 0 
	WHERE
		b.IS_DEL = '0' 
		AND b.CONT_TYPE = 1 
		AND s.end_date >= '2025-08-21' 
		AND s.end_date <= '2025-11-21' 
	) a,
	(
	SELECT
		max( s.end_date ) CONT_END_DATE,
		s.STORE_ID 
	FROM
		ibp_enrolment.bs_cont b
		LEFT JOIN ibp_enrolment.bs_cont_store_detail s ON b.CONT_NO = s.cont_no 
		AND s.is_del = 0 
	WHERE
		b.IS_DEL = '0' 
		AND b.CONT_TYPE = 1 
		AND s.end_date >= '2025-08-21' 
		AND s.end_date <= '2025-11-21' 
	GROUP BY
		s.STORE_ID 
	) b,
	bs_store c,
	( SELECT sd.store_group_id FROM ibp_enrolment.bs_cont_store_detail sd WHERE sd.is_del = 0 GROUP BY sd.store_group_id ) d,
	(
	SELECT
		a.cont_no,
		c.store_group_id,
		b.end_date,
		b.start_date,
		b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY,
		round(
			sum( c.unit_price_withouttax_total * ( datediff( c.end_date, c.start_date )+ 1 ) ) /(
				datediff( b.end_date, b.start_date )+ 1 
			),
			4 
		) price1,
		round(
			sum(
				c.unit_price_withouttax_total * (
				CASE
						
						WHEN c.end_date <(
							b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY 
							) THEN
							0 
							WHEN c.start_date <(
								b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY 
								) THEN
								datediff(
									c.end_date,
								GREATEST( c.start_date, b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY ))+ 1 ELSE datediff( c.end_date, c.start_date )+ 1 
							END 
							) 
							)/ sum(
							(
							CASE
									
									WHEN c.end_date <(
										b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY 
										) THEN
										0 
										WHEN c.start_date <(
											b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY 
											) THEN
											datediff(
												c.end_date,
											GREATEST( c.start_date, b.end_date - INTERVAL 1 YEAR + INTERVAL 1 DAY ))+ 1 ELSE datediff( c.end_date, c.start_date )+ 1 
										END 
										) 
									),
									4 
								) price2 
							FROM
								bs_cont a,
								bs_cont_store_group b,
								bs_cont_fee c 
							WHERE
								a.is_del = 0 
								AND b.is_del = 0 
								AND c.is_del = 0 
								AND a.CONT_NO = b.cont_no 
								AND b.cont_no = c.cont_no 
								AND b.id = c.store_group_id 
								AND b.end_date >= '2025-08-21' 
								AND b.end_date <= '2025-11-21' 
							GROUP BY
								a.cont_no,
								c.store_group_id 
							) AAA 
						WHERE
							a.STORE_ID = b.STORE_ID 
							AND b.CONT_END_DATE = a.CONT_END_DATE 
							AND a.STORE_ID = c.id 
							AND a.store_group_id = d.store_group_id 
							AND a.store_group_id = AAA.store_group_id 
							AND a.CONT_NO = AAA.CONT_NO 
							AND a.STORE_ID NOT IN (
							SELECT
								s.STORE_ID 
							FROM
								ibp_enrolment.bs_cont xxx
								LEFT JOIN ibp_enrolment.bs_cont_store_detail s ON xxx.CONT_NO = s.cont_no 
								AND s.is_del = 0 
							WHERE
								xxx.IS_DEL = '0' 
								AND s.STORE_ID IS NOT NULL 
								AND xxx.CONT_TYPE = 1 
								AND s.end_date > '2025-11-21' 
							) 
						ORDER BY
						a.MALL_ID,
	a.CONT_END_DATE
~~~

整理后的表格如下（已美化，内容结构与原数据一致，可直接复制到Excel或Markdown中使用）：

| area_name   | mall_code | mall_name             | COMPANY_NAME                      | CONT_NO           | cont_begin_date       | CONT_END_DATE         | STORE_ID | STORE_NAME               | RENT_SQUARE | sign_square | store_group_id | price_type | price1 | price2 |
|:------------|:----------|:----------------------|:----------------------------------|:------------------|:----------------------|:----------------------|:---------|:-------------------------|:------------|:------------|:---------------|:-----------|:-------|:-------|
| 北京战区     | P3267     | 万纬北京大兴园区       | 北京中远海运物流供应链有限公司     | HT-L010-00015385  | 2025-08-01 00:00:00   | 2025-09-05 00:00:00   | 13586    | 出租分区M2-3-1-1         | 884.07      | 884.07      | 13175          | 10         | 1.2951 | 1.2951 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 北京中远海运物流供应链有限公司     | HT-L010-00015385  | 2025-06-01 00:00:00   | 2025-09-05 00:00:00   | 10859    | F3-A-306                 | 44.3        | 44.3        | 13174          | 10         | 1.3876 | 1.3876 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 北京中远海运物流供应链有限公司     | HT-L010-00015385  | 2025-06-01 00:00:00   | 2025-09-05 00:00:00   | 10858    | F3-A-305                 | 44.3        | 44.3        | 13174          | 10         | 1.3876 | 1.3876 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 北京中远海运物流供应链有限公司     | HT-L010-00015385  | 2025-06-01 00:00:00   | 2025-09-05 00:00:00   | 13217    | 出租分区M2-2-1-2         | 2156.74     | 288.0       | 13174          | 10         | 1.3876 | 1.3876 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 北京中远海运物流供应链有限公司     | HT-L010-00012807  | 2024-09-05 00:00:00   | 2025-09-05 00:00:00   | 13589    | 出租分区M2-2-1-1-2       | 972.93      | 972.93      | 11031          | 10         | 1.1146 | 1.1141 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 北京中远海运物流供应链有限公司     | HT-L010-00012148  | 2024-09-05 00:00:00   | 2025-09-05 00:00:00   | 13588    | 出租分区M2-2-1-1-1       | 1000.0      | 1000.0      | 10396          | 10         | 1.1146 | 1.1141 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 鸿翔供应链科技（北京）有限公司     | HT-L010-00015136  | 2025-08-10 00:00:00   | 2025-09-09 00:00:00   | 10834    | 出租分区M3-3-2           | 2933.07     | 2933.07     | 12944          | 10         | 1.2951 | 1.2951 |
| 北京战区     | P3267     | 万纬北京大兴园区       | 鸿翔供应链科技（北京）有限公司     | HT-L010-00015625  | 2025-09-10 00:00:00   | 2025-09-30 00:00:00   | 10835    | 出租分区M3-3-3           | 2892.34     | 2892.34     | 13360          | 10         | 1.2951 | 1.2951 |
| 上海战区     | P1855     | 万纬上海金山亭林园区     | 上海祥隆储运有限公司               | HT-L020-00009795  | 2023-12-01 00:00:00   | 2025-09-30 00:00:00   | 732      | 出租分区B1-1             | 3740.02     | 3740.02     | 11924          | 10         | 0.6293 | 0.74   |
| 上海战区     | P1855     | 万纬上海金山亭林园区     | 上海祥隆储运有限公司               | HT-L020-00009795  | 2024-10-01 00:00:00   | 2025-09-30 00:00:00   | 733      | 出租分区B2-1             | 3020.19     | 3020.19     | 11925          | 10         | 0.74   | 0.74   |
| 上海战区     | P2238     | 万纬上海金山漕泾园区     | 宝供物流企业集团有限公司           | HT-L020-00015291  | 2025-08-17 00:00:00   | 2025-08-31 00:00:00   | 13443    | 出租分区M1-2-2-1         | 2088.64     | 2000.0      | 13141          | 10         | 0.9    | 0.9    |
| 上海战区     | P3031     | 万纬上海嘉定园区         | 珠海万纬物流发展有限公司           | HT-L020-00011749  | 2024-07-25 00:00:00   | 2025-08-24 00:00:00   | 10050    | 出租分区M2-2-3-1         | 191.09      | 191.09      | 11441          | 10         | 0.184  | 0.184  |
| 上海战区     | P3031     | 万纬上海嘉定园区         | 珠海万纬物流发展有限公司           | HT-L020-00011749  | 2024-07-25 00:00:00   | 2025-08-24 00:00:00   | 5916     | 出租单元M2-1-5-2         | 956.87      | 956.87      | 11441          | 10         | 0.184  | 0.184  |
| 上海战区     | P3031     | 万纬上海嘉定园区         | 珠海万纬物流发展有限公司           | HT-L020-00011749  | 2024-07-25 00:00:00   | 2025-08-24 00:00:00   | 5915     | 出租分区M2-1-5-1         | 865.55      | 865.55      | 11441          | 10         | 0.184  | 0.184  |
| 上海战区     | P3031     | 万纬上海嘉定园区         | 上海丝舫国际货物运输代理有限公司   | HT-L020-00014962  | 2025-08-01 00:00:00   | 2025-08-31 00:00:00   | 14150    | 出租分区M2-2-2-2         | 1955.1      | 1955.1      | 12830          | 10         | 0.925  | 0.925  |
| 上海战区     | P3031     | 万纬上海嘉定园区         | 上海心嘉物流有限公司               | HT-L020-00014354  | 2025-05-01 00:00:00   | 2025-10-31 00:00:00   | 10038    | 出租分区M1-1-1-2         | 2938.93     | 3035.38     | 12744          | 10         | 0.8836 | 0.8836 |
| 上海战区     | P3212     | 万纬上海青浦园区         | 海南安得智联供应链管理有限公司     | HT-L020-00012274  | 2024-09-02 00:00:00   | 2025-08-31 00:00:00   | 14171    | 出租分区M2-2-2- 2（西B） | 668.98      | 668.98      | 10428          | 10         | 0.45   | 0.45   |
| 上海战区     | P3212     | 万纬上海青浦园区         | 上海衡璞实业有限公司               | HT-L020-00015304  | 2025-08-15 00:00:00   | 2025-09-14 00:00:00   | 14073    | 出租分区M1-1-10-2-3      | 1620.29     | 400.0       | 13074          | 10         | 0.3323 | 0.3323 |
| 上海战区     | P3212     | 万纬上海青浦园区         | 上海衡璞实业有限公司               | HT-L020-00014711  | 2025-07-01 00:00:00   | 2025-09-30 00:00:00   | 3965     | 出租分区M2-1-3（西C）    | 3435.77     | 3435.77     | 12646          | 10         | 0.6173 | 0.6173 |